<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceData - Data Results</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/web-app/styles.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Add ethers.js for blockchain interactions -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
    
    <!-- Application scripts -->
    <script src="/web-app/metamask-connection.js"></script>
    <script src="/web-app/flare-services.js"></script>
    <script src="/web-app/wallet.js"></script>
    <script src="/web-app/copernicus-api.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="main-header">
            <div class="logo">
                <div class="logo-circle"></div>
                <h1>SpaceData</h1>
            </div>
            <div class="header-nav">
                <a href="#" class="sign-in-link">Account</a>
            </div>
        </header>

        <main>
            <!-- Back Button and Page Title -->
            <div class="page-header">
                <a href="/web-app/data-selection.html" class="back-button">
                    <span class="back-arrow">←</span>
                    <span>Back</span>
                </a>
                <div class="page-title-container">
                    <h2 class="page-title">Data Results</h2>
                    <p class="location-date">Barcelona Metropolitan Area • April 15, 2023</p>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tabs-container">
                <div class="tabs">
                    <div class="tab">Raw Data</div>
                    <div class="tab active">AI Analysis</div>
                </div>
            </div>

            <!-- Main Content Area -->
            <section class="section results-content">
                <!-- Earth Observation Image -->
                <div class="satellite-image-container">
                    <div class="satellite-image">
                        <div class="city-grid-pattern"></div>
                        <div class="water-body"></div>
                    </div>
                </div>

                <!-- Analysis Results Section -->
                <h3 class="results-section-title">AI Analysis Results</h3>
                
                <div class="analysis-charts">
                    <!-- Land Cover Distribution Chart -->
                    <div class="chart-container">
                        <h4 class="chart-title">Land Cover Distribution</h4>
                        <div class="donut-chart-container">
                            <div class="donut-chart">
                                <div class="donut-segment forest" style="--offset: 0; --length: 45.2"></div>
                                <div class="donut-segment urban" style="--offset: 45.2; --length: 30.1"></div>
                                <div class="donut-segment water" style="--offset: 75.3; --length: 24.7"></div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color forest"></div>
                                    <div class="legend-text">Forest (45.2%)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color urban"></div>
                                    <div class="legend-text">Urban (30.1%)</div>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color water"></div>
                                    <div class="legend-text">Water (24.7%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Change Detection Chart -->
                    <div class="chart-container">
                        <h4 class="chart-title">Change Detection</h4>
                        <div class="bar-chart-container">
                            <div class="bar-chart">
                                <div class="chart-axes">
                                    <div class="y-axis"></div>
                                    <div class="x-axis"></div>
                                    <div class="zero-line"></div>
                                </div>
                                <div class="bars">
                                    <div class="bar-group">
                                        <div class="bar forest negative" style="--height: 1.2"></div>
                                        <div class="bar-label">Forest</div>
                                        <div class="bar-value negative">-1.2%</div>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar urban positive" style="--height: 3.5"></div>
                                        <div class="bar-label">Urban</div>
                                        <div class="bar-value positive">+3.5%</div>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar water negative" style="--height: 0.3"></div>
                                        <div class="bar-label">Water</div>
                                        <div class="bar-value negative">-0.3%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI Chat Section -->
            <section class="section chat-section">
                <h3 class="chat-section-title">Chat with AI Assistant</h3>
                
                <div class="chat-messages">
                    <div class="chat-message user">
                        <div class="message-content">
                            What can you tell me about the urban development in this area?
                        </div>
                    </div>
                    <div class="chat-message ai">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            The urban areas cover approximately 30.1% of the region and have expanded by 3.5% since last year. The growth appears concentrated along transportation corridors in the eastern section with highest density in the central area.
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Ask about this satellite data...">
                    <button class="chat-send-button">
                        <span class="send-icon">↗</span>
                    </button>
                </div>
            </section>

            <!-- Actions Footer -->
            <section class="section actions-footer">
                <div class="action-buttons">
                    <button class="action-button primary">Download Report</button>
                    <button class="action-button secondary">Download Image</button>
                    <button class="action-button secondary">Share Results</button>
                </div>
                <div class="transaction-info">
                    Transaction: <span id="transaction-hash">0x8f2c4b...</span>
                    <span id="transaction-status" class="transaction-status">Pending</span>
                    <div id="blockchain-verification-details" class="verification-details" style="display: none;">
                        <p>Blockchain verification powered by Flare Network</p>
                        <p>Data integrity verified through Flare Data Consensus (FDC)</p>
                        <div class="verification-data">
                            <div class="verification-row">
                                <span class="verification-label">Request ID:</span>
                                <span id="request-id" class="verification-value">0x0000...</span>
                            </div>
                            <div class="verification-row">
                                <span class="verification-label">Attestation Status:</span>
                                <span id="attestation-status" class="verification-value">Pending</span>
                            </div>
                            <div class="verification-row">
                                <span class="verification-label">Attestation TX:</span>
                                <span id="attestation-tx" class="verification-value">0x0000...</span>
                            </div>
                            <div class="verification-row">
                                <span class="verification-label">Verified By:</span>
                                <span id="verified-by" class="verification-value">Flare Data Consensus</span>
                            </div>
                        </div>
                    </div>
                    <button id="verification-details-toggle" class="details-toggle">Show Details</button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="main-footer">
            <p>&copy; 2025 SpaceData • Powered by Flare Network</p>
        </footer>
    </div>

    <script>
        // Global state
        let satelliteData = null;
        let analysisResults = null;
        let currentView = 'analysis'; // 'raw' or 'analysis'
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const dataType = urlParams.get('dataType') || 'S2MSI2A';
        const startDate = urlParams.get('startDate') || '2023-04-15';
        const endDate = urlParams.get('endDate') || '2023-04-22';
        const coordinates = urlParams.get('coordinates') ? JSON.parse(decodeURIComponent(urlParams.get('coordinates'))) : null;
        const transactionHash = urlParams.get('txHash') || '0x8f2c4b7e9d6f8a1b2c3d4e5f6a7b8c9d0e1f2a3b';
        
        // Update location and date in the header
        document.querySelector('.location-date').textContent = `Selected Area • ${startDate} to ${endDate}`;
        
        // Load satellite data and analysis results
        async function loadData() {
            try {
                // Show loading state
                document.querySelector('.satellite-image').innerHTML = '<div class="loading-spinner"></div>';
                document.querySelector('.results-section-title').textContent = 'Loading data...';
                
                // Fetch satellite data
                console.log('Fetching satellite data...');
                satelliteData = await window.copernicusAPI.fetchSatelliteData({
                    dataType,
                    coordinates,
                    startDate,
                    endDate,
                    transactionHash
                });
                
                console.log('Satellite data received:', satelliteData);
                
                // Analyze satellite data
                console.log('Analyzing satellite data...');
                analysisResults = await window.copernicusAPI.analyzeSatelliteData(satelliteData);
                
                console.log('Analysis results received:', analysisResults);
                
                // Update UI with data
                updateUI();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.results-section-title').textContent = 'Error loading data';
                document.querySelector('.satellite-image').innerHTML = '<div class="error-message">Failed to load satellite data</div>';
            }
        }
        
        // Update UI with loaded data
        async function updateUI() {
            if (!satelliteData || !analysisResults) return;
            
            // Update satellite image
            const satelliteImageContainer = document.querySelector('.satellite-image');
            satelliteImageContainer.innerHTML = `<img src="${satelliteData.imageUrl}" alt="Satellite image" class="satellite-image-content">`;
            
            // Update results title
            document.querySelector('.results-section-title').textContent = currentView === 'analysis' ? 'AI Analysis Results' : 'Raw Satellite Data';
            
            if (currentView === 'analysis') {
                // Update land cover chart
                updateLandCoverChart(analysisResults.landCover);
                
                // Update change detection chart
                updateChangeDetectionChart(analysisResults.change);
                
                // Show analysis charts
                document.querySelector('.analysis-charts').style.display = 'flex';
                
            } else {
                // Hide analysis charts for raw view
                document.querySelector('.analysis-charts').style.display = 'none';
                
                // Show raw data (would be implemented in a real app)
                // This would display metadata, bands, etc.
            }
            
            // Update transaction hash and status
            document.getElementById('transaction-hash').textContent = transactionHash.substring(0, 8) + '...';
            
            // Add click event to transaction hash to open block explorer
            document.getElementById('transaction-hash').addEventListener('click', function() {
                const explorerUrl = `https://coston-explorer.flare.network/tx/${transactionHash}`;
                window.open(explorerUrl, '_blank');
            });
            
            // Style the transaction hash as a link
            document.getElementById('transaction-hash').style.cursor = 'pointer';
            document.getElementById('transaction-hash').style.textDecoration = 'underline';
            
            // Update transaction status
            const statusElement = document.getElementById('transaction-status');
            
            // Generate a deterministic request ID from the URL parameters
            const requestIdData = {
                dataType,
                startDate,
                endDate,
                coordinates,
                txHash: transactionHash
            };
            
            // Check blockchain verification status
            await checkBlockchainVerification(statusElement);
        }
        
        // Check blockchain verification status
        async function checkBlockchainVerification(statusElement) {
            try {
                // Initialize Flare services
                await window.flareServices.initFlareServices();
                
                // Generate a request ID for verification
                const requestId = await window.flareServices.generateRequestId({
                    dataType,
                    coordinates,
                    startDate,
                    endDate
                });
                
                console.log('Generated request ID:', requestId);
                
                // Update request ID in the UI
                document.getElementById('request-id').textContent = requestId.substring(0, 8) + '...';
                document.getElementById('request-id').title = requestId;
                
                // Check verification status
                const verificationResult = await window.flareServices.verifyAttestation(requestId);
                
                console.log('Verification result:', verificationResult);
                
                // Update verification status in the UI
                if (verificationResult.verified) {
                    // Transaction is verified
                    statusElement.textContent = 'Verified';
                    statusElement.className = 'transaction-status verified';
                    document.getElementById('attestation-status').textContent = 'Verified';
                    document.getElementById('attestation-status').className = 'verification-value verified';
                    
                    // If we have attestation response and proof, show them
                    if (verificationResult.attestationResponse) {
                        document.getElementById('attestation-tx').textContent = 
                            verificationResult.attestationResponse.substring(0, 8) + '...';
                        document.getElementById('attestation-tx').title = verificationResult.attestationResponse;
                    }
                } else {
                    // Transaction is pending or not found
                    if (verificationResult.status === 'pending') {
                        statusElement.textContent = 'Pending';
                        statusElement.className = 'transaction-status pending';
                        document.getElementById('attestation-status').textContent = 'Pending';
                        
                        // Check again after 10 seconds
                        setTimeout(async () => {
                            const updatedResult = await window.flareServices.verifyAttestation(requestId);
                            if (updatedResult.verified) {
                                statusElement.textContent = 'Verified';
                                statusElement.className = 'transaction-status verified';
                                document.getElementById('attestation-status').textContent = 'Verified';
                                document.getElementById('attestation-status').className = 'verification-value verified';
                            }
                        }, 10000);
                    } else if (verificationResult.status === 'not_found') {
                        statusElement.textContent = 'Not Found';
                        statusElement.className = 'transaction-status pending';
                        document.getElementById('attestation-status').textContent = 'Not Found';
                    } else {
                        statusElement.textContent = 'Error';
                        statusElement.className = 'transaction-status pending';
                        document.getElementById('attestation-status').textContent = 'Error';
                    }
                }
            } catch (error) {
                console.error('Error checking verification status:', error);
                statusElement.textContent = 'Error';
                statusElement.className = 'transaction-status pending';
                document.getElementById('attestation-status').textContent = 'Error';
            }
        }
        
        // Update land cover donut chart
        function updateLandCoverChart(landCover) {
            const donutChart = document.querySelector('.donut-chart');
            const chartLegend = document.querySelector('.chart-legend');
            
            // Clear existing segments and legend items
            donutChart.innerHTML = '';
            chartLegend.innerHTML = '';
            
            // Calculate total for percentages
            const total = Object.values(landCover).reduce((sum, value) => sum + value, 0);
            
            // Track offset for donut segments
            let offset = 0;
            
            // Create segments and legend items for each land cover type
            for (const [type, value] of Object.entries(landCover)) {
                const percentage = (value / total) * 100;
                
                // Create donut segment
                const segment = document.createElement('div');
                segment.className = `donut-segment ${type}`;
                segment.style.setProperty('--offset', offset);
                segment.style.setProperty('--length', percentage);
                donutChart.appendChild(segment);
                
                // Create legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color ${type}"></div>
                    <div class="legend-text">${type.charAt(0).toUpperCase() + type.slice(1)} (${percentage.toFixed(1)}%)</div>
                `;
                chartLegend.appendChild(legendItem);
                
                // Update offset for next segment
                offset += percentage;
            }
        }
        
        // Update change detection bar chart
        function updateChangeDetectionChart(changeData) {
            const barsContainer = document.querySelector('.bars');
            
            // Clear existing bars
            barsContainer.innerHTML = '';
            
            // Create bar for each change type
            for (const [type, value] of Object.entries(changeData)) {
                const isPositive = value >= 0;
                const absValue = Math.abs(value);
                
                // Create bar group
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                barGroup.innerHTML = `
                    <div class="bar ${type} ${isPositive ? 'positive' : 'negative'}" style="--height: ${absValue}"></div>
                    <div class="bar-label">${type.replace('Change', '')}</div>
                    <div class="bar-value ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${value}%</div>
                `;
                barsContainer.appendChild(barGroup);
            }
        }
        
        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Update current view
                currentView = this.textContent.trim().toLowerCase() === 'raw data' ? 'raw' : 'analysis';
                
                // Update UI
                updateUI();
            });
        });
        
        // Chat functionality
        const chatInput = document.querySelector('.chat-input');
        const chatSendButton = document.querySelector('.chat-send-button');
        const chatMessages = document.querySelector('.chat-messages');
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'chat-message user';
            userMessageElement.innerHTML = `
                <div class="message-content">
                    ${message}
                </div>
            `;
            chatMessages.appendChild(userMessageElement);
            
            // Clear input
            chatInput.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message ai typing';
            typingIndicator.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            
            // Scroll to bottom of chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Generate AI response based on analysis results
            setTimeout(() => {
                // Remove typing indicator
                chatMessages.removeChild(typingIndicator);
                
                // Create AI response
                const aiMessageElement = document.createElement('div');
                aiMessageElement.className = 'chat-message ai';
                
                // Generate response based on the query and analysis results
                let responseText = '';
                if (message.toLowerCase().includes('urban') || message.toLowerCase().includes('city')) {
                    responseText = `The urban areas cover approximately ${analysisResults.landCover.urban.toFixed(1)}% of the region and have expanded by ${analysisResults.change.urbanChange > 0 ? '+' : ''}${analysisResults.change.urbanChange}% since last year. The growth appears concentrated along transportation corridors with ${analysisResults.health.urbanDensity} density in the central area.`;
                } else if (message.toLowerCase().includes('forest') || message.toLowerCase().includes('tree')) {
                    responseText = `Forest coverage is currently at ${analysisResults.landCover.forest.toFixed(1)}% of the total area, with a change of ${analysisResults.change.forestChange > 0 ? '+' : ''}${analysisResults.change.forestChange}% compared to previous data. The vegetation health index is ${analysisResults.health.vegetationIndex}, indicating ${analysisResults.health.vegetationIndex > 0.7 ? 'good' : 'moderate'} overall forest health.`;
                } else if (message.toLowerCase().includes('water')) {
                    responseText = `Water bodies make up ${analysisResults.landCover.water.toFixed(1)}% of the area, with a change of ${analysisResults.change.waterChange > 0 ? '+' : ''}${analysisResults.change.waterChange}% from previous measurements. Water quality is rated as ${analysisResults.health.waterQuality}.`;
                } else {
                    // Generic response for other queries
                    responseText = `I've analyzed the data and can provide insights about ${message.toLowerCase()}. The selected area shows ${analysisResults.landCover.forest.toFixed(1)}% forest coverage, ${analysisResults.landCover.urban.toFixed(1)}% urban development, and ${analysisResults.landCover.water.toFixed(1)}% water bodies. ${analysisResults.insights[0]}`;
                }
                
                aiMessageElement.innerHTML = `
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        ${responseText}
                    </div>
                `;
                chatMessages.appendChild(aiMessageElement);
                
                // Scroll to bottom of chat
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1500);
        }
        
        chatSendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Action buttons
        document.querySelectorAll('.action-button').forEach(button => {
            button.addEventListener('click', function() {
                const action = this.textContent.trim();
                
                if (action === 'Download Report') {
                    // Simulate report download
                    const reportBlob = new Blob([JSON.stringify({
                        metadata: satelliteData.metadata,
                        analysis: analysisResults,
                        timestamp: new Date().toISOString(),
                        transaction: transactionHash
                    }, null, 2)], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(reportBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `satellite-report-${startDate}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                } else if (action === 'Download Image') {
                    // Simulate image download by opening in new tab
                    window.open(satelliteData.imageUrl, '_blank');
                    
                } else if (action === 'Share Results') {
                    // Simulate sharing by copying link to clipboard
                    const shareUrl = `${window.location.origin}${window.location.pathname}?dataType=${dataType}&startDate=${startDate}&endDate=${endDate}&txHash=${transactionHash}`;
                    
                    navigator.clipboard.writeText(shareUrl)
                        .then(() => alert('Link copied to clipboard!'))
                        .catch(err => console.error('Failed to copy link:', err));
                }
            });
        });
        
        // Verification details toggle
        document.getElementById('verification-details-toggle').addEventListener('click', function() {
            const detailsElement = document.getElementById('blockchain-verification-details');
            const isHidden = detailsElement.style.display === 'none';
            
            // Toggle visibility
            detailsElement.style.display = isHidden ? 'block' : 'none';
            
            // Update button text
            this.textContent = isHidden ? 'Hide Details' : 'Show Details';
        });
        
        // Load data when page loads
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
